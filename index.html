<!-- app created by Mohamed shabaan (Moshft) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Exchange Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const socket = io();

        function App() {
            const [name, setName] = useState(localStorage.getItem('chatUser') || '');
            const [isJoined, setIsJoined] = useState(!!localStorage.getItem('chatUser'));
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [myId, setMyId] = useState('');
            const [typing, setTyping] = useState('');
            const scrollRef = useRef();

            useEffect(() => {
                socket.on('yourID', (id) => setMyId(id));
                socket.on('chatMessage', (msg) => {
                    setMessages(prev => [...prev, msg]);
                    // Ø¥Ø°Ø§ ÙˆØµÙ„Øª Ø±Ø³Ø§Ù„Ø© ÙˆØ£Ù†Ø§ Ù„Ø³Øª Ø§Ù„Ù…Ø±Ø³Ù„ØŒ Ø£Ø®Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ù†Ù†ÙŠ Ù‚Ø±Ø£ØªÙ‡Ø§
                    if (msg.senderId !== socket.id) {
                        socket.emit('markAsRead', msg.messageId);
                    }
                });

                socket.on('messageReadByOther', (msgId) => {
                    setMessages(prev => prev.map(m => m.messageId === msgId ? {...m, read: true} : m));
                });

                socket.on('userTyping', (data) => setTyping(`${data.user} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`));
                socket.on('userStopTyping', () => setTyping(''));

                if(isJoined) socket.emit('join', name);
                
                return () => socket.off();
            }, [isJoined]);

            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const handleJoin = () => {
                if(name.trim()) {
                    localStorage.setItem('chatUser', name);
                    setIsJoined(true);
                }
            };

            const sendMessage = (file = null) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const type = file.type.startsWith('image') ? 'image' : file.type.startsWith('video') ? 'video' : 'document';
                        socket.emit('sendMessage', { content: e.target.result, type, fileName: file.name });
                    };
                    reader.readAsDataURL(file);
                } else if (input.trim()) {
                    socket.emit('sendMessage', { content: input, type: 'text' });
                    setInput('');
                    socket.emit('stopTyping');
                }
            };

            const downloadFile = (content, fileName) => {
                const link = document.createElement('a');
                link.href = content;
                link.download = fileName || 'download';
                link.click();
            };

            if (!isJoined) {
                return (
                    <div className="h-screen flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 text-center">
                            <div className="text-5xl mb-4">ðŸš€</div>
                            <h1 className="text-2xl font-bold mb-2 text-slate-800">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹</h1>
                            <p className="text-slate-500 mb-6 italic">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„ØªØ¨Ø¯Ø£ ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                            <input 
                                className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±..."
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                            />
                            <button onClick={handleJoin} className="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-black transition-all shadow-lg">Ø¯Ø®ÙˆÙ„</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen max-w-5xl mx-auto flex flex-col p-2 md:p-6">
                    <div className="flex-1 bg-white rounded-[2rem] shadow-2xl flex flex-col overflow-hidden border border-slate-200 glass">
                        {/* Header */}
                        <div className="p-5 border-b flex justify-between items-center bg-white/50">
                            <div>
                                <h2 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <span className="w-3 h-3 bg-green-500 rounded-full"></span>
                                    {name}
                                </h2>
                                <button onClick={() => { localStorage.removeItem('chatUser'); window.location.reload(); }} className="text-[10px] text-blue-500 underline">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
                            </div>
                            <div className="text-slate-400 text-xs font-mono">ID: {myId.substring(0,6)}</div>
                            {/* Users Active */}
                            <div className="text-slate-400 text-xs font-mono">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†: {messages.reduce((acc, msg) => acc.add(msg.user), new Set()).size}</div>

                        </div>

                        {/* Chat Box */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar bg-slate-50/30">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.senderId === myId ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`relative group max-w-[85%] md:max-w-[60%] p-4 rounded-[1.5rem] shadow-sm ${msg.senderId === myId ? 'bg-slate-900 text-white rounded-br-none' : 'bg-white border text-slate-800 rounded-bl-none'}`}>
                                        <p className="text-[10px] font-bold mb-1 opacity-60">{msg.senderId === myId ? 'Ø£Ù†Øª' : msg.user}</p>
                                        
                                        {msg.type === 'text' && <p className="text-sm leading-relaxed break-words">{msg.content}</p>}
                                        
                                        {msg.linkPreview && (
                                            <div className="mt-3 bg-black/5 rounded-xl p-2 border border-black/10 text-xs">
                                                {msg.linkPreview.images?.[0] && <img src={msg.linkPreview.images[0]} className="w-full h-32 object-cover rounded-lg mb-2" />}
                                                <h4 className="font-bold mb-1 truncate">{msg.linkPreview.title}</h4>
                                                <p className="opacity-70 line-clamp-2">{msg.linkPreview.description}</p>
                                            </div>
                                        )}

                                        {(msg.type === 'image' || msg.type === 'video') && (
                                            <div className="relative mt-2 rounded-xl overflow-hidden group">
                                                {msg.type === 'image' ? <img src={msg.content} className="max-h-80 w-full object-cover" /> : <video src={msg.content} controls className="max-h-80 w-full" />}
                                                <button 
                                                    onClick={() => downloadFile(msg.content, msg.fileName)}
                                                    className="absolute top-2 left-2 bg-black/50 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all"
                                                >ðŸ“¥</button>
                                            </div>
                                        )}

                                        {msg.type === 'document' && (
                                            <div className="flex items-center justify-between gap-4 p-3 bg-blue-500/10 rounded-xl mt-2">
                                                <span className="text-xs truncate">ðŸ“„ {msg.fileName}</span>
                                                <button onClick={() => downloadFile(msg.content, msg.fileName)} className="bg-blue-500 text-white px-3 py-1 rounded-lg text-[10px]">ØªÙ†Ø²ÙŠÙ„</button>
                                            </div>
                                        )}

                                        <div className="flex justify-end items-center gap-1 mt-1">
                                            <span className="text-[9px] opacity-50">{msg.time}</span>
                                            {msg.senderId === myId && (
                                                <span className={`text-[10px] ${msg.read ? 'text-blue-400' : 'text-slate-400'}`}>
                                                    {msg.read ? 'âœ“âœ“' : 'âœ“'}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <div ref={scrollRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white/80 border-t">
                            <p className="text-[10px] text-slate-400 mb-2 h-3 italic">{typing}</p>
                            <div className="flex items-center gap-3 bg-slate-100 p-2 rounded-2xl">
                                <label className="cursor-pointer p-2 hover:bg-slate-200 rounded-full transition-all">
                                    <input type="file" className="hidden" onChange={(e) => sendMessage(e.target.files[0])} />
                                    <span className="text-xl">ðŸ“Ž</span>
                                </label>
                                <input 
                                    className="flex-1 bg-transparent border-none outline-none text-sm p-2"
                                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø·Ø§Ù‹..."
                                    value={input}
                                    onChange={(e) => {
                                        setInput(e.target.value);
                                        socket.emit('typing');
                                    }}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                />
                                <button onClick={() => sendMessage()} className="bg-slate-900 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:scale-105 transition-all">Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <!-- app created by Mohamed shabaan (Moshft) -->
</body>
</html>